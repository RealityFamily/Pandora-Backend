<html>
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css"/>
    <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script th:src="@{/resources/pwstrength.js}"></script>
    <title th:utext="#{label.form.title}">form</title>
</head>
<body>

<div class="container">
    <h1 th:text="#{label.form.title}">form</h1>
    <form action="/user/registration" th:object="${user}" method="POST" enctype="utf8">

        <div class="form-group row">
            <label for="nickName" class="col-sm-3" th:utext="#{label.user.nickName}">Никнейм</label>
            <span class="col-sm-5"><input id="nickName" class="form-control" name="nickName" value="" required="required"/></span>
            <span id="nickNameError" class="alert alert-danger col-sm-4" style="display:none"></span>
        </div>

        <div class="form-group row">
            <label for="email" class="col-sm-3" th:utext="#{label.user.email}">Email</label>
            <span class="col-sm-5"><input id="email" type="email" class="form-control" name="email" value="" required="required"/></span>
            <span id="emailError" class="alert alert-danger col-sm-4" style="display:none"></span>
        </div>

        <div class="form-group row">
            <label for="password" class="col-sm-3" th:utext="#{label.user.password}">Пароль</label>
            <span class="col-sm-5"><input id="password" type="password"  class="form-control" name="password" value="" required="required" autocomplete="new-password"/></span>
            <span id="passwordError" class="alert alert-danger col-sm-4" style="display:none"></span>
        </div>

        <div class="form-group row">
            <label for="matchPassword" class="col-sm-3" th:utext="#{label.user.confirmPass}">Повторите пароль</label>
            <span class="col-sm-5"><input id="matchPassword" class="form-control" name="matchingPassword" value="" required="required" type="password" autocomplete="new-password"/></span>
            <span id="globalError" class="alert alert-danger col-sm-4" style="display:none"></span>
        </div>

        <button class="btn btn-primary" type="submit" th:utext="#{label.form.submit}">submit</button>
    </form>

    <p th:text="${message}">_____</p>
</div>

<script th:inline="javascript">
    var serverContext = window.location.origin;

    $(document).ready(function () {
        $('form').submit(function(event) {
            register(event);
        });

        $(":password").keyup(function(){
            if($("#password").val() != $("#matchPassword").val()){
                $("#globalError").show().html([[#{PasswordMatches.user}]]);
            }else{
                $("#globalError").html("").hide();
            }
        });

        options = {
            common: {minChar:8},
            ui: {
                showVerdictsInsideProgressBar:true,
                showErrors:true,
                errorMessages:{
                    wordLength: [[#{error.wordLength}]],
                    wordNotEmail: [[#{error.wordNotEmail}]],
                    wordSequences: [[#{error.wordSequences}]],
                    wordLowercase: [[#{error.wordLowercase}]],
                    wordUppercase: [[#{error.wordUppercase}]],
                    wordOneNumber: [[#{error.wordOneNumber}]],
                    wordOneSpecialChar: [[#{error.wordOneSpecialChar}]]
                }
            }
        };
        $('#password').pwstrength(options);
    });

    function register(event){
        event.preventDefault();
        $(".alert").html("").hide();
        $(".error-list").html("");
        if($("#password").val() != $("#matchPassword").val()){
            $("#globalError").show().html([[#{PasswordMatches.user}]]);
            return;
        }
        var formData= $('form').serialize();
        console.log(serverContext + "/user/registration")
        $.post(serverContext + "/user/registration",formData ,function(data){
            if(data.message == "success"){
                window.location.href = serverContext + "/successRegister";
            }

        })
            .fail(function(data) {
                console.log(data)

                if(data.responseJSON.error.indexOf("MailError") > -1)
                {
                    window.location.href = serverContext + "emailError";
                }
                else if(data.responseJSON.error == "UserAlreadyExist"){
                    $("#emailError").show().html(data.responseJSON.message);
                }
                else if(data.responseJSON.error.indexOf("InternalError") > -1){
                    window.location.href = serverContext + "login?message=" + data.responseJSON.message;
                }
                else{
                    var errors = $.parseJSON(data.responseJSON.message);
                    $.each( errors, function( index,item ){
                        if (item.field){
                            $("#"+item.field+"Error").show().append(item.defaultMessage+"<br/>");
                        }
                        else {
                            $("#globalError").show().append(item.defaultMessage+"<br/>");
                        }

                    });
                }
            });
    }

</script>

</body>

</html>
